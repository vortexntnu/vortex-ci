name: Reusable Source Build
# Reusable GitHub Actions workflow to build all ROS 2 packages from source
on:
  workflow_call:
    inputs:
      ros_distro:
        description: "ROS Distribution (e.g., humble, jazzy)"
        required: false
        default: "humble"
        type: string
      os_name:
        description: "Operating System to run the workflow on"
        required: false
        default: "ubuntu-22.04"
        type: string
      ref:
        description: "Git branch or tag to checkout"
        required: false
        default: ${{ github.event.repository.default_branch }}
        type: string
      vcs_repo_file_url:
        description: "URL to the vcs repositories file"
        required: false
        default: ""
        type: string
      skip_tests:
        description: "Skip running tests"
        required: false
        default: false
        type: boolean
      gcc_version:
        description: "GCC version to install"
        required: false
        default: "11" # Default GCC version commonly available on Ubuntu 22.04
        type: string
      requirements_url:
        description: "URL to the requirements.sh file for additional dependencies"
        required: false
        default: ""
        type: string
jobs:
  build:
    runs-on: ${{ inputs.os_name }}
    steps:
      - name: set gcc and g++ version
        if: inputs.gcc_version != '11'
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install gcc-${{ inputs.gcc_version }} g++-${{ inputs.gcc_version }} -y
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${{ inputs.gcc_version }} 60
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-${{ inputs.gcc_version }} 60
      - name: setup ROS 2 environment
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ inputs.ros_distro }}
      - name: Download and install extra dependencies
        if: inputs.requirements_url != ''
        run: |
          echo "Downloading and executing requirements.sh from: ${{ inputs.requirements_url }}"
          curl -o requirements.sh ${{ inputs.requirements_url }}
          chmod +x requirements.sh
          ./requirements.sh
      # Check out the repository if no external requirements URL is provided
      - name: Check out the repository
        if: inputs.requirements_url == ''
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      # Install extra dependencies from a local requirements.sh file if it exists in the root directory
      - name: Install extra dependencies from local requirements.sh
        if: inputs.requirements_url == ''
        run: |
          if [ -f requirements.sh ]; then
            echo "Executing local requirements.sh from repository root directory"
            chmod +x requirements.sh
            ./requirements.sh
          else
            echo "No local requirements.sh found in root directory"
          fi
      - name: build and test ROS 2 packages
        uses: ros-tooling/action-ros-ci@v0.3
        with:
          target-ros2-distro: ${{ inputs.ros_distro }}
          vcs-repo-file-url: ${{ inputs.vcs_repo_file_url }}
          skip-tests: ${{ inputs.skip_tests }}
